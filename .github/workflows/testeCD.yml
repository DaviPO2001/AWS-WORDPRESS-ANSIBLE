name: CD Pipeline

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]   # só dispara depois que o CI terminar
    types:
      - completed


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Configurar Python e Ansible
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip
          pip3 install ansible

      - name: Configurar inventário Ansible
        run: |
          echo "[servidor]" > hosts.ini
          echo "52.15.204.67 ansible_user=ubuntu ansible_ssh_private_key_file=/home/runner/.ssh/id_rsa" >> hosts.ini

      - name: Adicionar chave SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Rodar playbook Ansible
        run: ansible-playbook -i hosts.ini deploy-wordpress.yml
